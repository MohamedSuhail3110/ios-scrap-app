workflows:
  ios-build:
    name: iOS Build
    environment:
      vars:
        APPLE_ID: scrapzoneglobal@gmail.com
        APP_SPECIFIC_PASSWORD: aqce-btsv-rllm-khlk
        CM_CERT_PASSWORD: testpassword
      xcode: latest

    scripts:
      - name: Decode and install certificate
        script: |
          echo "üîê Installing distribution certificate..."
          base64 -D -i ci/ios_certificate_p12_base64.txt -o ios_certificate.p12
          security create-keychain -p "" build.keychain
          security import ios_certificate.p12 -P "$CM_CERT_PASSWORD" -A -t cert -f pkcs12
          security list-keychains -d user -s build.keychain
          security default-keychain -d user -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings build.keychain

      - name: Install provisioning profile
        script: |
          echo "üì± Installing provisioning profile..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          base64 -D -i ci/comscrapglobal_mobileprovision_base64.txt -o ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision

      - name: Install JS dependencies
        script: |
          npm install

      - name: Generate ios/ folder with Expo
        script: |
          if [ ! -d "ios" ]; then
            echo "‚ö° No ios/ folder found, generating with expo prebuild..."
            npx expo prebuild --clean
          fi

      - name: Install iOS dependencies
        script: |
          cd ios
          pod install --repo-update
          cd ..

      - name: Build iOS archive
        script: |
          echo "üèó Building iOS archive with manual code signing..."
          PROFILE_UUID=$(grep -a -A1 "<key>UUID</key>" ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision | grep -oE "([A-F0-9-]{36})")
          echo "‚úÖ Using Provisioning Profile UUID: $PROFILE_UUID"

          xcodebuild \
            -workspace ios/Scrap.xcworkspace \
            -scheme Scrap \
            -sdk iphoneos \
            -configuration Release \
            archive \
            -archivePath $CM_BUILD_DIR/Scrap.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
            DEVELOPMENT_TEAM="" \
            PRODUCT_BUNDLE_IDENTIFIER="com.scrap.global"

      - name: Export IPA
        script: |
          echo "üì¶ Exporting .ipa file..."
          xcodebuild \
            -exportArchive \
            -archivePath $CM_BUILD_DIR/Scrap.xcarchive \
            -exportOptionsPlist ios/exportOptions.plist \
            -exportPath $CM_BUILD_DIR/ios_output

    publishing:
      app_store_connect:
        apple_id: $APPLE_ID
        password: $APP_SPECIFIC_PASSWORD
